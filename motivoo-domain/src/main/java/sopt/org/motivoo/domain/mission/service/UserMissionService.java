package sopt.org.motivoo.domain.mission.service;

import static sopt.org.motivoo.domain.external.s3.S3BucketDirectory.*;
import static sopt.org.motivoo.domain.mission.entity.CompletedStatus.*;
import static sopt.org.motivoo.domain.mission.exception.MissionExceptionType.*;
import static sopt.org.motivoo.domain.user.exception.UserExceptionType.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.stream.Collectors;

import org.jetbrains.annotations.NotNull;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import sopt.org.motivoo.common.advice.BusinessException;
import sopt.org.motivoo.domain.external.firebase.FirebaseService;
import sopt.org.motivoo.domain.external.s3.PreSignedUrlResponse;
import sopt.org.motivoo.domain.external.s3.S3BucketDirectory;
import sopt.org.motivoo.domain.external.s3.S3Service;
import sopt.org.motivoo.domain.health.entity.ExerciseLevel;
import sopt.org.motivoo.domain.health.entity.Health;
import sopt.org.motivoo.domain.health.entity.HealthNote;
import sopt.org.motivoo.domain.health.repository.HealthRetriever;
import sopt.org.motivoo.domain.mission.dto.request.MissionImgUrlCommand;
import sopt.org.motivoo.domain.mission.dto.request.MissionStepStatusCommand;
import sopt.org.motivoo.domain.mission.dto.request.TodayMissionChoiceCommand;
import sopt.org.motivoo.domain.mission.dto.response.MissionHistoryResult;
import sopt.org.motivoo.domain.mission.dto.response.MissionImgUrlResult;
import sopt.org.motivoo.domain.mission.dto.response.MissionStepStatusResult;
import sopt.org.motivoo.domain.mission.dto.response.OpponentGoalStepsResult;
import sopt.org.motivoo.domain.mission.dto.response.TodayMissionResult;
import sopt.org.motivoo.domain.mission.entity.CompletedStatus;
import sopt.org.motivoo.domain.mission.entity.Mission;
import sopt.org.motivoo.domain.mission.entity.MissionQuest;
import sopt.org.motivoo.domain.mission.entity.MissionType;
import sopt.org.motivoo.domain.mission.entity.UserMission;
import sopt.org.motivoo.domain.mission.entity.UserMissionChoices;
import sopt.org.motivoo.domain.mission.exception.MissionException;
import sopt.org.motivoo.domain.mission.repository.MissionQuestRetriever;
import sopt.org.motivoo.domain.mission.repository.MissionRetriever;
import sopt.org.motivoo.domain.mission.repository.UserMissionChoicesRetriever;
import sopt.org.motivoo.domain.mission.repository.UserMissionRetriever;
import sopt.org.motivoo.domain.user.entity.User;
import sopt.org.motivoo.domain.user.entity.UserType;
import sopt.org.motivoo.domain.user.exception.UserException;
import sopt.org.motivoo.domain.user.repository.UserRepository;
import sopt.org.motivoo.domain.user.repository.UserRetriever;

@Slf4j
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class UserMissionService {
	private final UserMissionRetriever userMissionRetriever;
	private final UserMissionChoicesRetriever userMissionChoicesRetriever;
	private final UserRetriever userRetriever;
	private final MissionRetriever missionRetriever;
	private final MissionQuestRetriever missionQuestRetriever;
	private final HealthRetriever healthRetriever;

	private final S3Service s3Service;
	private final FirebaseService firebaseService;

	private static final int MAX_MISSION_CHOICES = 2;

	@Transactional
	public MissionImgUrlResult getMissionImgUrl(final MissionImgUrlCommand request, final Long userId) {
		User user = userRetriever.getUserById(userId);
		checkedUserMissionEmpty(user);
		checkMatchedUserWithdraw(user);

		UserMission todayMission = user.getCurrentUserMission();
		checkMissionChoice(todayMission);
		// checkMissionStepComplete(todayMission);

		PreSignedUrlResponse preSignedUrl = s3Service.getUploadPreSignedUrl(
			S3BucketDirectory.of(request.imgPrefix()));


		todayMission.updateImgUrl(s3Service.getImgByFileName(request.imgPrefix(), preSignedUrl.fileName()));
		todayMission.updateCompletedStatus(SUCCESS);
		return MissionImgUrlResult.of(preSignedUrl.url(), preSignedUrl.fileName());
	}


	@Transactional
	public MissionHistoryResult getUserMissionHistory(final Long userId) {
		User myUser = userRetriever.getUserById(userId);
		User opponentUser = userRetriever.getMatchedUserWith(myUser);
		if (myUser.getUserMissions().isEmpty()) {
			return MissionHistoryResult.of(myUser);
		}

		UserMission todayMission = myUser.getCurrentUserMission();
		//checkMissionChoice(todayMission);

		Map<LocalDate, List<UserMission>> missionsByDate = groupUserMissionsByDate(userId, opponentUser.getId());
		log.info("missionsByDate size: {}", missionsByDate.size());
		for (LocalDate localDateTime : missionsByDate.keySet()) {
			log.info("missionsByDate.get(localDateTime) size: {}-{}", missionsByDate.get(localDateTime).size(), localDateTime);

			missionsByDate.get(localDateTime).stream()
				.filter(um -> um.getImgUrl() != null)
				.forEach(um -> {
					try {
						String imgUrl = s3Service.getURL(MISSION_PREFIX.value() + um.getImgUrl());
						log.info("S3ÏóêÏÑú Î∞õÏïÑÏò® Ïù¥ÎØ∏ÏßÄ URL: {}", imgUrl);
						// um.updateImgUrl(imgUrl);
					} catch (IllegalArgumentException | BusinessException e) {
						log.error(e.getMessage());
						um.updateImgUrl(null);
					}
				});

			if (!localDateTime.equals(LocalDate.now())) {
				missionsByDate.get(localDateTime).stream()
					.filter(um -> um.getImgUrl() == null && !um.getMission().getTarget().equals(UserType.NONE))
					.forEach(um -> um.updateCompletedStatus(FAIL));
			}
			missionsByDate.get(localDateTime).stream()
				.filter(um -> um.getImgUrl() != null && !um.getMission().getTarget().equals(UserType.NONE))
				.forEach(um -> um.updateCompletedStatus(SUCCESS));

			missionsByDate.get(localDateTime).stream()
				.filter(um -> um.getMission().getTarget().equals(UserType.NONE))
				.forEach(um -> um.updateCompletedStatus(NONE));

			// log.info("key={}, value={} ü•π{}", localDateTime, missionsByDate.get(localDateTime).get(0).getMission().getContent(),
			// 	missionsByDate.get(localDateTime).get(1).getMission().getContent());
		}
		return MissionHistoryResult.of(myUser, todayMission, missionsByDate);
	}

	private Map<LocalDate, List<UserMission>> groupUserMissionsByDate(Long myUserId, Long opponentUserId) {
		List<User> users = userRetriever.getUsersByIds(myUserId, opponentUserId);  // Îëò Ï§ë 1Î™ÖÏù¥ ÌÉàÌá¥Ìï† Í≤ΩÏö∞Î•º ÎåÄÎπÑ, IDÍ∞íÏúºÎ°úÎßå Ï°∞Ìöå
		List<UserMission> emptyUserMissions = new ArrayList<>();

		// Îëê Ïú†Ï†ÄÍ∞Ä Í∞ÄÏßÑ Î™®Îì† UserMissionÏùò createdAt ÎÇ†Ïßú ÏßëÌï©
		Set<LocalDate> userDates = new HashSet<>();
		users.forEach(user -> {
			userDates.addAll(user.getUserMissions().stream()
				.map(userMission -> userMission.getCreatedAt().toLocalDate())
				.collect(Collectors.toSet()));
			log.info("userDates.size(): {}", userDates.size());
		});

		users.forEach(user -> {
			// Í∞Å Ïú†Ï†ÄÍ∞Ä Í∞ÄÏßÑ ÎÇ†Ïßú ÏßëÌï©
			Set<LocalDate> myDates = user.getUserMissions().stream()
				.map(userMission -> userMission.getCreatedAt().toLocalDate())
				.collect(Collectors.toSet());

			// userDates Í≥º myDatesÎ•º ÎπÑÍµêÌïòÏó¨ ÏóÜÎäî ÎÇ†ÏßúÏóêÎäî Îπà Í∞íÏùò UserMission ÏÉùÏÑ±Ìï¥Ï£ºÍ∏∞
			userDates.forEach(date -> {
				if (!myDates.contains(date)) {
					UserMission um = createEmptyUserMission(user, date);
					emptyUserMissions.add(um);
				}
			});
		});
		userMissionRetriever.saveAll(emptyUserMissions);

		// Í∑∏Î£πÌôî
		Map<LocalDate, List<UserMission>> dateGroups = users.stream()
			.flatMap(user -> user.getUserMissions().stream())
			.collect(Collectors.groupingBy(userMission -> userMission.getCreatedAt().toLocalDate()));

		Map<LocalDate, List<UserMission>> sortedGroups = new TreeMap<>(Comparator.reverseOrder());
		sortedGroups.putAll(dateGroups);

		return sortedGroups;
	}

	@Transactional
	public Long choiceTodayMission(final TodayMissionChoiceCommand request, final Long userId) {
		User user = userRetriever.getUserById(userId);
		checkMatchedUserWithdraw(user);

		validateTodayMissionRequest(request.missionId(), user);

		Mission mission = missionRetriever.getMissionById(request.missionId());
		if (!user.getUserMissions().isEmpty()) {
			UserMission currentMission = user.getCurrentUserMission();

			if (validateTodayDateMission(currentMission)) {
				currentMission.updateMissionFromEmpty(mission);
				return currentMission.getId();
			}
		}

		UserMission userMission = createTodayUserMission(mission, user);
		user.clearPreUserMissionChoice();  // Ïò§ÎäòÏùò ÎØ∏ÏÖòÏùÑ ÏÑ†Ï†ïÌñàÎã§Î©¥, ÏÑ†ÌÉùÏßÄ Î¶¨Ïä§Ìä∏Îäî ÎπÑÏõåÏ£ºÍ∏∞
		return userMission.getId();
	}

	private static void validateTodayMissionRequest(Long missionId, User user) {
		boolean missionExists = user.getUserMissionChoice().stream()
			.anyMatch(userMissionChoices -> userMissionChoices.getMission().getId().equals(missionId));

		if (!missionExists) {
			throw new MissionException(NOT_EXIST_TODAY_MISSION_CHOICE);
		}
	}

	@Transactional
	public MissionStepStatusResult getMissionCompleted(final MissionStepStatusCommand request, final Long userId) {
		User myUser = userRetriever.getUserById(userId);
		User opponentUser = userRetriever.getMatchedUserWith(myUser);

		int myStep = request.myStepCount();
		int opponentStep = request.opponentStepCount();

		/*try {
			Map<String, Integer> userNowStepCounts = firebaseService.selectUserStep(List.of(myUser.getId(), opponentUser.getId()));
			log.info("userNowStepCount Map - size: {}, 1Î≤à: {}", userNowStepCounts.size(), userNowStepCounts.get(userId.toString()));
			myStep = userNowStepCounts.get(myUser.getId().toString());
			opponentStep = userNowStepCounts.get(opponentUser.getId().toString());
		} catch (CannotCreateTransactionException | NullPointerException e) {
			log.error("Ìä∏ÎûúÏû≠ÏÖò Ï≤òÎ¶¨ Ïã§Ìå®! - Ïú†Ï†Ä ÎØ∏ÏÖò Îã¨ÏÑ± ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú FB Ï°∞Ìöå");
		}*/

		int myGoalStep = 0;
		int opponentGoalStep = 0;

		log.info("ÌòÑÏû¨ Ï†ëÏÜçÌïú Ïú†Ï†Ä - {} X ÎÇòÏôÄ Îß§Ïπ≠Îêú Î∂ÄÎ™®ÏûêÎÖÄ Ïú†Ï†Ä - {}", myUser.getNickname(), opponentUser.getNickname());

		boolean myUserMissionsEmpty = myUser.getUserMissions().isEmpty();
		boolean opponentUserMissionsEmpty = opponentUser.getUserMissions().isEmpty();

		if (myUserMissionsEmpty && opponentUserMissionsEmpty) {
			return MissionStepStatusResult.of(myUser, opponentUser, myGoalStep, opponentGoalStep, false, false);
		}

		if (!opponentUserMissionsEmpty) {
			UserMission opponentCurrentUserMission = opponentUser.getCurrentUserMission();
			opponentGoalStep = (opponentCurrentUserMission != null && validateTodayDateMission(opponentCurrentUserMission)) ? opponentCurrentUserMission.getMission().getStepCount() : 0;
			assert opponentCurrentUserMission != null;
			// isStepCountCompleted(opponentStep, opponentCurrentUserMission);
		}

		if (!myUserMissionsEmpty) {
			UserMission myCurrentUserMission = myUser.getCurrentUserMission();
			if (!validateTodayDateMission(myCurrentUserMission)) {
				return MissionStepStatusResult.of(myUser, opponentUser, myGoalStep, opponentGoalStep, false, false);
			}
			myGoalStep = myCurrentUserMission.getMission().getStepCount();
			boolean stepCountCompleted = myStep >= myCurrentUserMission.getMission().getStepCount();

			return MissionStepStatusResult.of(myUser, opponentUser, myGoalStep, opponentGoalStep, stepCountCompleted, myCurrentUserMission.getImgUrl() != null);
		}

		return MissionStepStatusResult.of(myUser, opponentUser, myGoalStep, opponentGoalStep, false, false);


	/*	UserMission todayMission = myUser.getCurrentUserMission();
		UserMission opponentTodayMission = opponentUser.getCurrentUserMission();
		if (opponentTodayMission != null) {
			opponentGoalStep = opponentTodayMission.getMission().getStepCount();
		}


		if (todayMission != null && !validateTodayDateMission(todayMission)) {
			log.info("todayMission = {} at {}", todayMission.getMission().getContent(), todayMission.getCreatedAt());
			checkMissionChoice(todayMission);
			myGoalStep = todayMission.getMission().getStepCount();

			int currentStepCount = request.myStepCount();

			return MissionStepStatusResponse.of(myUser, opponentUser, myGoalStep, opponentGoalStep, isStepCountCompleted(currentStepCount, todayMission));
		}
		return MissionStepStatusResponse.of(myUser, opponentUser, 0, 0, false);*/

	}

	public OpponentGoalStepsResult getOpponentGoalSteps(final Long userId) {
		User myUser = userRetriever.getUserById(userId);
		User opponentUser = userRetriever.getMatchedUserWith(myUser);

		if (!opponentUser.getUserMissions().isEmpty()) {
			UserMission opponentCurrentUserMission = opponentUser.getCurrentUserMission();
			int opponentGoalStep = (opponentCurrentUserMission != null && validateTodayDateMission(opponentCurrentUserMission)) ? opponentCurrentUserMission.getMission().getStepCount() : 0;
			assert opponentCurrentUserMission != null;
			return OpponentGoalStepsResult.of(opponentGoalStep);
		}
		throw new MissionException(NOT_EXIST_TODAY_MISSION_CHOICE);
	}

	private boolean isStepCountCompleted(int currentStepCount, UserMission todayMission) {
		boolean isStepCountCompleted = currentStepCount >= todayMission.getMission().getStepCount();
		if (isStepCountCompleted) {
			todayMission.updateCompletedStatus(SUCCESS);
			log.info("Ïò§ÎäòÏùò ÎØ∏ÏÖò Îã¨ÏÑ± ÏôÑÎ£åÎ°ú DB ÏóÖÎç∞Ïù¥Ìä∏ Î∞òÏòÅ!");
		}
		return isStepCountCompleted;
	}

	@Transactional  // TODO Ïó¨Í∏∞ ÏµúÎåÄÌïú Î∂ÑÎ¶¨Ìï¥Î≥¥Ïûê
	public TodayMissionResult getTodayMission(final Long userId) {
		User user = userRetriever.getUserById(userId);
		checkMatchedUserWithdraw(user);
		log.info("TodayMissionChoicesÏù¥ ÏûàÏùÑÍπå, ÏóÜÏùÑÍπå? {}Í∞ú ÏûàÏùå „Öã„Öã", user.getUserMissionChoice().size());

		/**
		 * ÏïÑÏßÅ Ïò§ÎäòÏùò ÎØ∏ÏÖòÏù¥ ÏÑ†Ï†ïÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
		 * */
		// 1) Ï≤òÏùå Í∞ÄÏûÖÌïú Ïú†Ï†ÄÏùò Í≤ΩÏö∞ or ÌïÑÌÑ∞ÎßÅ Î°úÏßÅÏùÑ Í±∞Ïπú Ï†ÅÏù¥ ÏóÜÎäî Í≤ΩÏö∞ -> ÌïÑÌÑ∞ Í±∞ÏπòÍ∏∞
		if ((user.getUserMissions().isEmpty() && user.getUserMissionChoice().isEmpty())) {
			log.info("Ïú†Ï†Ä {}Ïùò UserMissions, UserMissionChoices Î¶¨Ïä§Ìä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏùå", user.getNickname());

			List<UserMissionChoices> todayMissionChoices = filterTodayUserMission(user);
			user.setPreUserMissionChoice(todayMissionChoices);
			log.info("Ï≤´ Í∞ÄÏûÖ Ïú†Ï†Ä Ïò§ÎäòÏùò ÎØ∏ÏÖò ÏÑ†ÌÉùÏßÄ ÏÑ∏ÌåÖ ÏôÑÎ£å! : {}", todayMissionChoices.size());
			return TodayMissionResult.of(todayMissionChoices);
		}

		if (!user.getUserMissions().isEmpty()) {
			UserMission todayMission = user.getCurrentUserMission();
			if (validateTodayDateMission(todayMission) && !todayMission.getMission().getTarget().equals(UserType.NONE)) {
				user.clearPreUserMissionChoice();
				return TodayMissionResult.of(todayMission);
			}
		}
		if (!user.getUserMissionChoice().isEmpty()) {
			return TodayMissionResult.of(user.getUserMissionChoice());
		}

		// 2) ÌïÑÌÑ∞ÎßÅ Î°úÏßÅÏùÑ Ìïú Î≤à Ïù¥ÏÉÅ Í±∞Ïπú Í≤ΩÏö∞ -> Ï†ÄÏû•Îêú Í±∞ Í∞ÄÏ†∏Ïò§Í∏∞
		UserMission todayMission = user.getCurrentUserMission();

		if (!validateTodayDateMission(todayMission) && user.getUserMissionChoice().isEmpty()) {
			log.info("Ïú†Ï†Ä {}Ïùò UserMissions ÏÑ†ÌÉùÏßÄ Î¶¨Ïä§Ìä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏùå", user.getNickname());

			List<UserMissionChoices> todayMissionChoices = filterTodayUserMission(user);
			user.setPreUserMissionChoice(todayMissionChoices);
			log.info("Ïú†Ï†Ä Ïò§ÎäòÏùò ÎØ∏ÏÖò ÏÑ†ÌÉùÏßÄ ÏÑ∏ÌåÖ ÏôÑÎ£å! : {}", todayMissionChoices.size());
			return TodayMissionResult.of(todayMissionChoices);
		}

		if (!validateTodayDateMission(todayMission) && !user.getUserMissionChoice().isEmpty()) {
			log.info("Ïò§ÎäòÏùò ÎØ∏ÏÖò ÏÑ†ÌÉùÏßÄÍ∞Ä ÏÑ∏ÌåÖÎêú ÏÉÅÌÉú: {}", user.getUserMissionChoice().size());
			return TodayMissionResult.of(user.getUserMissionChoice());
		}

		// ÏÉÅÎåÄ Ï∏°ÏóêÏÑú ÎØ∏ÏÖò ÌûàÏä§ÌÜ†Î¶¨Î•º Î®ºÏ†Ä Ï°∞ÌöåÌïú Í≤ΩÏö∞
		if (user.getUserMissionChoice().isEmpty() && todayMission.getMission().getTarget().equals(UserType.NONE)) {
			List<UserMissionChoices> todayMissionChoices = filterTodayUserMission(user);
			user.setPreUserMissionChoice(todayMissionChoices);
			log.info("Ïú†Ï†Ä Ïò§ÎäòÏùò ÎØ∏ÏÖò ÏÑ†ÌÉùÏßÄ ÏÑ∏ÌåÖ ÏôÑÎ£å! : {}", todayMissionChoices.size());
			return TodayMissionResult.of(todayMissionChoices);
		}

		/**
		 * 	 Ïò§ÎäòÏùò ÎØ∏ÏÖòÏù¥ ÏÑ†Ï†ïÎêú Í≤ΩÏö∞
		 */
		log.info("Ïò§ÎäòÏùò ÎØ∏ÏÖòÏù¥ ÏÑ†Ï†ïÎêú ÏÉÅÌÉú: {}", todayMission.getMission().getContent());
		return TodayMissionResult.of(todayMission);
		// throw new MissionException(FAIL_TO_GET_TODAY_MISSION);
	}


	private List<UserMissionChoices> filterTodayUserMission(User user) {
		final List<Mission> missionChoicesFiltered = getFilteredMissions(user);

		List<UserMissionChoices> missionChoices = new ArrayList<>();
		for (int i = 0; i < Math.min(missionChoicesFiltered.size(), 2); i++) {
			UserMissionChoices missionChoice = UserMissionChoices.builder()
				.mission(missionChoicesFiltered.get(i))
				.user(user).build();
			missionChoices.add(userMissionChoicesRetriever.save(missionChoice));
		}

		// user.setPreUserMissionChoice(missionChoices);
		// if (missionChoices.isEmpty() || missionChoices.size() == 1) {
		// 	throw new MissionException(NOT_FILTERED_TODAY_MISSION);
		// }
		return missionChoices;
	}



	private List<UserMissionChoices> filterTodayUserMissionV2(User user) {
		// Î∂ÄÎ™® ÎØ∏ÏÖò or ÏûêÏãù ÎØ∏ÏÖò Î¶¨Ïä§Ìä∏
		List<Mission> missions = missionRetriever.getMissionsByTarget(user);
		Health health = healthRetriever.getHealthByUser(user);
		List<HealthNote> userNotes = health.getHealthNotes();
		ExerciseLevel exerciseLevel = health.getExerciseLevel();

		return missions.parallelStream()
			.filter(mission -> {
				List<HealthNote> missionNotes = HealthNote.of(mission.getHealthNotes());
				boolean hasUserNotes = missionNotes.stream().anyMatch(userNotes::contains);
				boolean hasExerciseLevel = MissionType.of(mission.getType()).containsLevel(exerciseLevel);
				return !hasUserNotes && !hasExerciseLevel;
			})
			.limit(MAX_MISSION_CHOICES)
			.map(mission -> UserMissionChoices.builder()
				.mission(mission)
				.user(user).build())
			.map(userMissionChoicesRetriever::save)
			.toList();
	}

	@NotNull
	public List<Mission> getFilteredMissions(User user) {
		final List<Mission> missionChoicesFiltered = new ArrayList<>();

		// Î∂ÄÎ™® ÎØ∏ÏÖò or ÏûêÏãù ÎØ∏ÏÖò Î¶¨Ïä§Ìä∏
		List<Mission> missions = missionRetriever.getMissionsByTarget(user);
		log.info("{} ÎØ∏ÏÖò Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò¥", user.getType().getValue());
		Health health = healthRetriever.getHealthByUser(user);

		List<HealthNote> userNotes = health.getHealthNotes();
		ExerciseLevel exerciseLevel = health.getExerciseLevel();

		log.info("Mission ÌïÑÌÑ∞ÎßÅ ÏãúÏûë!");
		for (Mission mission : missions) {
			List<HealthNote> missionNotes = HealthNote.of(mission.getHealthNotes());
			boolean hasUserNotes = missionNotes.stream().anyMatch(userNotes::contains);
			boolean hasExerciseLevel = MissionType.of(mission.getType()).containsLevel(exerciseLevel);

			if (!hasUserNotes && !hasExerciseLevel) {
				missionChoicesFiltered.add(mission);
			}
		}
		log.info("ÎßûÏ∂§ Mission Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä(Shuffle Ï†Ñ): {}Í∞ÄÏßÄ", missionChoicesFiltered.size());
		Collections.shuffle(missionChoicesFiltered);

		return missionChoicesFiltered;
	}

	@NotNull
	private UserMission createTodayUserMission(Mission mission, User user) {
		MissionQuest missionQuest = missionQuestRetriever.getRandomMissionQuest();

		UserMission userMission = UserMission.builder()
			.mission(mission)
			.missionQuest(missionQuest)
			.user(user)
			.completedStatus(IN_PROGRESS).build();

		userMissionRetriever.saveUserMission(userMission);
		user.addUserMission(userMission);
		return userMission;
	}

	

	@NotNull
	private UserMission createEmptyUserMission(User user, LocalDate date) {
		UserMission um = UserMission.builderForEmpty()
			.completedStatus(NONE)
			.user(user)
			.mission(missionRetriever.getEmptyMission())
			.missionQuest(missionQuestRetriever.getRandomMissionQuest())
			.build();

		userMissionRetriever.saveUserMission(um);
		um.updateCreatedAt(date.atStartOfDay());  // ÎèôÏùºÌïú ÎÇ†ÏßúÎ°ú ÏÑ∏ÌåÖ
		user.addUserMission(um);
		return um;
	}

	// Îß§Ïπ≠Îêú Ïú†Ï†ÄÏùò ÌÉàÌá¥ Ïó¨Î∂Ä Í≤ÄÏÇ¨
	private void checkMatchedUserWithdraw(User user) {
		User opponentUser = userRetriever.getMatchedUserWith(user);
		if (opponentUser.isDeleted()) {
			throw new UserException(ALREADY_WITHDRAW_USER);
		}
	}

	// Ïò§ÎäòÏùò ÎØ∏ÏÖò Î¶¨Ïä§Ìä∏ ÎπÑÏñ¥ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
	private static void checkedUserMissionEmpty(User user) {
		if (user.getUserMissions().isEmpty()) {
			throw new MissionException(EMPTY_USER_MISSIONS);
		}
	}

	// Ïò§ÎäòÏùò ÎØ∏ÏÖò ÏÑ†Ï†ï Ïó¨Î∂Ä Í≤ÄÏÇ¨
	private void checkMissionChoice(UserMission todayMission) {
		if (!validateTodayDateMission(todayMission)) {
			throw new MissionException(NOT_CHOICE_TODAY_MISSION);
		}
	}

	// Ïò§ÎäòÏùò ÎØ∏ÏÖò Í±∏Ïùå Ïàò Îã¨ÏÑ± ÏÉÅÌÉú ÌôïÏù∏
	private void checkMissionStepComplete(UserMission todayMission) {
		if (!todayMission.getCompletedStatus().equals(SUCCESS)) {
			throw new MissionException(NOT_COMPLETE_MISSION_STEPS_SUCCESS);
		}
	}

	// Ïò§ÎäòÏùò ÎØ∏ÏÖòÏóê ÎåÄÌïú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
	private boolean validateTodayDateMission(UserMission todayMission) {
		if (!todayMission.getCreatedAt().toLocalDate().equals(LocalDate.now())) {
			log.info("Ïò§Îäò ÎÇ†ÏßúÏôÄ ÎèôÏùºÌïòÏßÄ ÏïäÏùÄ ÏµúÍ∑º ÎØ∏ÏÖò!");
			return false;
		}
		return true;
	}


	// Îç∞Î™®Îç∞Ïù¥Ïö© ÎçîÎØ∏ ÎØ∏ÏÖò ÌûàÏä§ÌÜ†Î¶¨ ÏÉùÏÑ±
	@Transactional
	public void demoHistory(final Long parentchildId) {
		List<User> parentchildUsers = userRetriever.getUsersByParentchildId(parentchildId);
		if (parentchildUsers.size() == 2) {
			createUserMissionHistoryDummy(parentchildUsers.get(0), parentchildUsers.get(1));
		}
	}

	private Mission getRandomSingleMission(List<Mission> missions) {
		int index = (int) (Math.random() * missions.size());
		return missions.get(index);
	}

	private void createUserMission(User user, String imgUrl, CompletedStatus completedStatus, LocalDateTime createdAt) {
		UserMission userMission = UserMission.builderForDemo()
			.completedStatus(completedStatus)
			.mission(getRandomSingleMission(getFilteredMissions(user)))
			.missionQuest(missionQuestRetriever.getRandomMissionQuest())
			.user(user).build();

		user.addUserMission(userMission);
		userMissionRetriever.saveUserMission(userMission);

		userMission.updateImgUrl(imgUrl);
		userMission.updateCreatedAt(createdAt);
		userMission.updateUpdatedAt(createdAt);

		userMissionRetriever.saveUserMission(userMission);
	}



	private void createUserMissionHistoryDummy(User user, User matchedUser) {
		createUserMission(user, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/um2.jpg", SUCCESS, LocalDateTime.of(2024, 1, 18, 12, 0, 0));
		createUserMission(user, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/cat.jpg", SUCCESS, LocalDateTime.of(2024, 1, 17, 12, 0, 0));
		createUserMission(user, null, FAIL, LocalDateTime.of(2024, 1, 16, 12, 0, 0));
		createUserMission(user, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/tl_baseball.jpg", SUCCESS, LocalDateTime.of(2024, 1, 15, 12, 0, 0));
		createUserMission(user, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/motivoo.jpg", SUCCESS, LocalDateTime.of(2024, 1, 13, 12, 0, 0));
		createUserMission(user, null, FAIL, LocalDateTime.of(2024, 1, 11, 12, 0, 0));
		createUserMission(user, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/jo.jpg", SUCCESS, LocalDateTime.of(2024, 1, 9, 12, 0, 0));
		createUserMission(matchedUser, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/motivoo_all1.png", SUCCESS, LocalDateTime.of(2024, 1, 18, 12, 0, 0));
		createUserMission(matchedUser, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/leejs.jpg", SUCCESS, LocalDateTime.of(2024, 1, 17, 12, 0, 0));
		createUserMission(matchedUser, null, FAIL, LocalDateTime.of(2024, 1, 16, 12, 0, 0));
		createUserMission(matchedUser, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/motivoo_all3.png", SUCCESS, LocalDateTime.of(2024, 1, 15, 12, 0, 0));
		createUserMission(matchedUser, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/motivoo_all2.jpg", SUCCESS, LocalDateTime.of(2024, 1, 13, 12, 0, 0));
		createUserMission(matchedUser, null, FAIL, LocalDateTime.of(2024, 1, 11, 12, 0, 0));
		createUserMission(matchedUser, "https://motivoo-server-bucket.s3.ap-northeast-2.amazonaws.com/mission/um.jpg", SUCCESS, LocalDateTime.of(2024, 1, 9, 12, 0, 0));
	}
}